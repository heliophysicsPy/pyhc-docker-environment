name: PyHC Environment Pipeline V2 Workflow

on:
  schedule:
    - cron: '0 14 * * *'  # Runs at 7 AM Mountain Time (UTC-7)
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force build even if no changes detected'
        required: false
        default: 'false'
        type: boolean
      generate_spreadsheet:
        description: 'Generate dependency spreadsheet (for debugging/analysis)'
        required: false
        default: 'false'
        type: boolean

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        ref: main-v2

    - name: Extract Python version from environment.yml
      id: python_version
      run: |
        VERSION=$(python3 utils/version_utils.py)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Using Python version: $VERSION"

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ steps.python_version.outputs.version }}

    - name: Install uv
      run: pip install uv

    - name: Install Pipeline Dependencies
      run: pip install -r pipeline_requirements.txt

    - name: Generate Dependency Spreadsheet
      id: generate_spreadsheet
      if: github.event.inputs.generate_spreadsheet == 'true'
      run: python pipeline_v2.py --generate-spreadsheet

    - name: Upload Spreadsheet Artifact
      if: github.event.inputs.generate_spreadsheet == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: dependency-spreadsheet
        path: ${{ steps.generate_spreadsheet.outputs.spreadsheet_path }}
        retention-days: 30

    - name: Run Pipeline V2 Check
      id: pipeline_check
      run: |
        if [ "${{ github.event.inputs.force_build }}" == "true" ]; then
          python pipeline_v2.py --force
        else
          python pipeline_v2.py
        fi

    - name: Build and Push Docker Images
      if: steps.pipeline_check.outputs.should_run == 'true'
      id: build_and_push
      run: python utils/docker_operations.py ./docker ${{ secrets.DOCKER_HUB_USERNAME }} ${{ secrets.DOCKER_HUB_TOKEN }}

    - name: Update Lockfile After Successful Build
      if: steps.pipeline_check.outputs.should_run == 'true'
      run: python pipeline_v2.py --post-build

    - name: Update README Table
      if: steps.pipeline_check.outputs.should_run == 'true'
      run: python utils/update_readme.py

    - name: Commit and Push Repo Changes
      if: steps.pipeline_check.outputs.should_run == 'true' || github.event.inputs.generate_spreadsheet == 'true'
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

        # Add lockfile and README if build ran
        if [ "${{ steps.pipeline_check.outputs.should_run }}" == "true" ]; then
          git add resolved-versions.txt README.md
        fi

        # Add spreadsheet if generated
        if [ "${{ github.event.inputs.generate_spreadsheet }}" == "true" ]; then
          git add spreadsheets/
        fi

        # Build commit message based on what changed
        if [ "${{ steps.pipeline_check.outputs.should_run }}" == "true" ] && [ "${{ github.event.inputs.generate_spreadsheet }}" == "true" ]; then
          MSG="Update PyHC environment lockfile and README; add dependency spreadsheet"
        elif [ "${{ steps.pipeline_check.outputs.should_run }}" == "true" ]; then
          MSG="Update PyHC environment lockfile and README"
        else
          MSG="Add dependency spreadsheet"
        fi

        git commit -m "$MSG" || exit 0
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Update science-platforms-coordination to Trigger Binder Rebuild
      if: steps.pipeline_check.outputs.should_run == 'true'
      run: |
        # Clone the target repo using a PAT with push permissions
        git clone https://${{ secrets.SCIENCE_PLATFORMS_PAT }}@github.com/heliophysicsPy/science-platforms-coordination.git coordination_repo
        cd coordination_repo
        git checkout pyhc

        # Use sed to update the 'FROM' line in the Dockerfile with the new version
        sed -i "s|^FROM spolson/pyhc-environment:.*|FROM spolson/pyhc-environment:${{ steps.build_and_push.outputs.docker_version }}|" binder/Dockerfile

        git config user.name 'github-actions[bot]'
        git config user.email 'github-actions[bot]@users.noreply.github.com'
        git add binder/Dockerfile

        if [ -z "$(git status --porcelain)" ]; then
          echo "No changes to commit."
        else
          git commit -m "Update base image version to ${{ steps.build_and_push.outputs.docker_version }}"
          git push origin pyhc
        fi

    - name: Notify on Successful Push
      if: steps.pipeline_check.outputs.should_run == 'true'
      uses: peter-evans/create-or-update-comment@v4
      with:
        issue-number: 2
        body: |
          **[V2 Pipeline]** Docker Hub images and GitHub repo have been updated.

          Reason: ${{ steps.pipeline_check.outputs.change_reason }}

          Package changes:
          ```
          ${{ steps.pipeline_check.outputs.package_changes }}
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
