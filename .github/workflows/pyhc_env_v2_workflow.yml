name: PyHC Environment Pipeline V2 Workflow

on:
  schedule:
    - cron: '0 14 * * *'  # Runs at 7 AM Mountain Time (UTC-7)
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force build even if no changes detected'
        required: false
        default: 'false'
        type: boolean
      generate_spreadsheet:
        description: 'Generate dependency spreadsheet (for debugging/analysis)'
        required: false
        default: 'false'
        type: boolean

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        ref: main-v2

    - name: Extract Python version from environment.yml
      id: python_version
      run: |
        VERSION=$(python3 utils/version_utils.py)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Using Python version: $VERSION"

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ steps.python_version.outputs.version }}

    - name: Install uv
      run: pip install uv

    - name: Install Pipeline Dependencies
      run: pip install -r pipeline_requirements.txt

    - name: Generate Dependency Spreadsheet
      id: generate_spreadsheet
      if: github.event.inputs.generate_spreadsheet == 'true'
      run: python pipeline_v2.py --generate-spreadsheet

    - name: Upload Spreadsheet Artifact
      if: github.event.inputs.generate_spreadsheet == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: dependency-spreadsheet
        path: ${{ steps.generate_spreadsheet.outputs.spreadsheet_path }}
        retention-days: 30

    # ============================================
    # Auto-pin packages to latest PyPI versions
    # ============================================
    - name: Auto-pin packages to latest versions
      id: auto_pin
      run: python pipeline_v2.py --auto-pin

    - name: Skip if no PyHC updates (unless forced)
      if: steps.auto_pin.outputs.pyhc_packages_changed != 'true' && github.event.inputs.force_build != 'true'
      run: |
        echo "No PyHC package updates detected. Skipping build."
        echo "Note: Transitive dependency changes don't trigger rebuilds."
        echo "Use 'Force build' option to rebuild anyway."

    # ============================================
    # Dependency Resolution with Constraints
    # ============================================
    - name: Run uv compile (generate lockfile)
      if: steps.auto_pin.outputs.pyhc_packages_changed == 'true' || github.event.inputs.force_build == 'true'
      id: compile
      run: python pipeline_v2.py --compile
      continue-on-error: true

    - name: Post conflict to issue on failure
      if: steps.compile.outcome == 'failure'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh issue comment 2 --body "## Dependency Conflict Detected

        Failed to resolve dependencies after auto-pinning to latest PyHC versions.

        **Changed packages:**
        \`\`\`
        ${{ steps.auto_pin.outputs.changed_packages }}
        \`\`\`

        **Error details:** Check workflow logs for full error message.

        **Workflow run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

    - name: Fail workflow on compile error
      if: steps.compile.outcome == 'failure'
      run: |
        echo "ERROR: Dependency resolution failed. See issue #2 for details."
        exit 1

    # ============================================
    # Docker Build and Push
    # ============================================
    - name: Build and Push Docker Images
      if: (steps.auto_pin.outputs.pyhc_packages_changed == 'true' || github.event.inputs.force_build == 'true') && steps.compile.outcome == 'success'
      id: build_and_push
      run: python utils/docker_operations.py ./docker ${{ secrets.DOCKER_HUB_USERNAME }} ${{ secrets.DOCKER_HUB_TOKEN }}

    - name: Update Lockfile After Successful Build
      if: (steps.auto_pin.outputs.pyhc_packages_changed == 'true' || github.event.inputs.force_build == 'true') && steps.compile.outcome == 'success'
      run: python pipeline_v2.py --post-build

    - name: Update README Table
      if: (steps.auto_pin.outputs.pyhc_packages_changed == 'true' || github.event.inputs.force_build == 'true') && steps.compile.outcome == 'success'
      run: python utils/update_readme.py

    # ============================================
    # Commit and Push Changes
    # ============================================
    - name: Commit and Push Repo Changes
      if: (steps.auto_pin.outputs.pyhc_packages_changed == 'true' || github.event.inputs.force_build == 'true') && steps.compile.outcome == 'success'
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

        # Add all changed files (packages.txt with new pins, lockfile, README)
        git add packages.txt constraints.txt resolved-versions.txt README.md

        # Build commit message
        MSG="Update PyHC environment: auto-pin packages and rebuild"

        git commit -m "$MSG" || echo "No changes to commit"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Commit spreadsheet if generated
      if: github.event.inputs.generate_spreadsheet == 'true'
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add spreadsheets/
        git commit -m "Add dependency spreadsheet" || echo "No spreadsheet changes"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ============================================
    # Trigger Binder Rebuild
    # ============================================
    - name: Update science-platforms-coordination to Trigger Binder Rebuild
      if: (steps.auto_pin.outputs.pyhc_packages_changed == 'true' || github.event.inputs.force_build == 'true') && steps.compile.outcome == 'success'
      run: |
        # Clone the target repo using a PAT with push permissions
        git clone https://${{ secrets.SCIENCE_PLATFORMS_PAT }}@github.com/heliophysicsPy/science-platforms-coordination.git coordination_repo
        cd coordination_repo
        git checkout pyhc

        # Use sed to update the 'FROM' line in the Dockerfile with the new version
        sed -i "s|^FROM spolson/pyhc-environment:.*|FROM spolson/pyhc-environment:${{ steps.build_and_push.outputs.docker_version }}|" binder/Dockerfile

        git config user.name 'github-actions[bot]'
        git config user.email 'github-actions[bot]@users.noreply.github.com'
        git add binder/Dockerfile

        if [ -z "$(git status --porcelain)" ]; then
          echo "No changes to commit."
        else
          git commit -m "Update base image version to ${{ steps.build_and_push.outputs.docker_version }}"
          git push origin pyhc
        fi

    # ============================================
    # Notifications
    # ============================================
    - name: Notify on Successful Push
      if: (steps.auto_pin.outputs.pyhc_packages_changed == 'true' || github.event.inputs.force_build == 'true') && steps.compile.outcome == 'success'
      uses: peter-evans/create-or-update-comment@v4
      with:
        issue-number: 2
        body: |
          **[V2 Pipeline]** Docker Hub images and GitHub repo have been updated.

          **PyHC packages updated:**
          ```
          ${{ steps.auto_pin.outputs.changed_packages }}
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
