name: PyHC Environment Pipeline Workflow

on:
  schedule:
    - cron: '0 14 * * *'  # Runs at 7 AM Mountain Time (UTC-7)
  workflow_dispatch:
    inputs:
      skip_checks:
        description: 'Skip auto-pin and compile (quick deploy mode)'
        required: false
        default: 'false'
        type: boolean
      force_build:
        description: 'Force build even if no changes detected'
        required: false
        default: 'false'
        type: boolean
      generate_spreadsheet:
        description: 'Generate dependency spreadsheet (set false to skip)'
        required: false
        default: 'true'
        type: boolean
      spreadsheet_workers:
        description: 'Number of workers for spreadsheet generation'
        required: false
        default: '2'
        type: string
      docker_tag_suffix:
        description: 'Optional suffix appended to date tag (e.g., -temp)'
        required: false
        default: ''
        type: string

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Extract Python version from environment.yml
      id: python_version
      run: |
        VERSION=$(python3 utils/version_utils.py)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Using Python version: $VERSION"

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ steps.python_version.outputs.version }}

    - name: Install uv
      run: pip install uv

    - name: Install Pipeline Dependencies
      run: pip install -r pipeline_requirements.txt

    # ============================================
    # Auto-pin packages to latest PyPI versions
    # ============================================
    - name: Auto-pin packages to latest versions
      id: auto_pin
      if: github.event.inputs.skip_checks != 'true'
      run: python pipeline.py --auto-pin

    - name: Skip if no PyHC updates (unless forced or quick deploy)
      if: github.event.inputs.skip_checks != 'true' && steps.auto_pin.outputs.pyhc_packages_changed != 'true' && github.event.inputs.force_build != 'true'
      run: |
        echo "No PyHC package updates detected. Skipping build."
        echo "Note: Transitive dependency changes don't trigger rebuilds."
        echo "Use 'Force build' option to rebuild anyway."

    # ============================================
    # Dependency Resolution with Constraints
    # ============================================
    - name: Run uv compile (generate lockfile)
      if: github.event.inputs.skip_checks != 'true' && (steps.auto_pin.outputs.pyhc_packages_changed == 'true' || github.event.inputs.force_build == 'true')
      id: compile
      run: python pipeline.py --compile
      continue-on-error: true

    # ============================================
    # Optional Spreadsheet Generation (for diagnostics and analysis)
    # Runs only when updates/force would run pipeline, regardless of compile success.
    # Skipped in quick deploy mode.
    # ============================================
    - name: Generate Dependency Spreadsheet
      id: generate_spreadsheet
      if: github.event.inputs.skip_checks != 'true' && (steps.auto_pin.outputs.pyhc_packages_changed == 'true' || github.event.inputs.force_build == 'true') && (github.event_name != 'workflow_dispatch' || github.event.inputs.generate_spreadsheet != 'false')
      env:
        PYHC_SPREADSHEET_WORKERS: ${{ github.event.inputs.spreadsheet_workers || '2' }}
        PIP_DISABLE_PIP_VERSION_CHECK: '1'
      run: python pipeline.py --generate-spreadsheet

    - name: Upload Spreadsheet Artifact
      if: github.event.inputs.skip_checks != 'true' && (steps.auto_pin.outputs.pyhc_packages_changed == 'true' || github.event.inputs.force_build == 'true') && (github.event_name != 'workflow_dispatch' || github.event.inputs.generate_spreadsheet != 'false')
      uses: actions/upload-artifact@v4
      with:
        name: dependency-spreadsheet
        path: ${{ steps.generate_spreadsheet.outputs.spreadsheet_path }}
        retention-days: 30

    - name: Post conflict to issue on failure
      if: github.event.inputs.skip_checks != 'true' && steps.compile.outcome == 'failure'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh issue comment 2 --body "## Dependency Conflict Detected

        Failed to resolve dependencies after auto-pinning to latest PyHC versions.

        **Changed packages:**
        \`\`\`
        ${{ steps.auto_pin.outputs.changed_packages }}
        \`\`\`

        **Error details:**
        \`\`\`
        ${{ steps.compile.outputs.compile_error }}
        \`\`\`

        **Workflow run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

    - name: Fail workflow on compile error
      if: github.event.inputs.skip_checks != 'true' && steps.compile.outcome == 'failure'
      run: |
        if [ "${{ github.event_name != 'workflow_dispatch' || github.event.inputs.generate_spreadsheet != 'false' }}" = "true" ]; then
          echo "ERROR: Dependency resolution failed. See issue #2 and this run's spreadsheet artifact for details."
        else
          echo "ERROR: Dependency resolution failed. See issue #2 for details."
        fi
        exit 1

    # ============================================
    # Docker Build and Push
    # ============================================
    - name: Build and Push Docker Images
      if: github.event.inputs.skip_checks == 'true' || ((steps.auto_pin.outputs.pyhc_packages_changed == 'true' || github.event.inputs.force_build == 'true') && steps.compile.outcome == 'success')
      id: build_and_push
      run: python utils/docker_operations.py ./docker ${{ secrets.DOCKER_HUB_USERNAME }} ${{ secrets.DOCKER_HUB_TOKEN }} "${{ github.event.inputs.docker_tag_suffix || '' }}"

    - name: Update Lockfile After Successful Build
      if: github.event.inputs.skip_checks != 'true' && (steps.auto_pin.outputs.pyhc_packages_changed == 'true' || github.event.inputs.force_build == 'true') && steps.compile.outcome == 'success'
      run: python pipeline.py --post-build

    - name: Update README Table
      if: github.event.inputs.skip_checks == 'true' || ((steps.auto_pin.outputs.pyhc_packages_changed == 'true' || github.event.inputs.force_build == 'true') && steps.compile.outcome == 'success')
      run: python utils/update_readme.py

    # ============================================
    # Commit and Push Changes
    # ============================================
    - name: Commit and Push Repo Changes
      if: github.event.inputs.skip_checks == 'true' || ((steps.auto_pin.outputs.pyhc_packages_changed == 'true' || github.event.inputs.force_build == 'true') && steps.compile.outcome == 'success')
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

        # Add files based on mode
        if [ "${{ github.event.inputs.skip_checks }}" = "true" ]; then
          # Quick deploy: only add README (no lockfile changes)
          git add README.md
          MSG="Quick deploy: rebuild Docker images"
        else
          # Normal mode: add all changed files (packages/constraints/lockfile + README)
          git add docker/pyhc-environment/contents/packages.txt docker/pyhc-environment/contents/constraints.txt docker/pyhc-environment/contents/resolved-versions.txt README.md
          MSG="Update PyHC environment: auto-pin packages and rebuild"
        fi

        git commit -m "$MSG" || echo "No changes to commit"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Commit spreadsheet if generated
      if: github.event.inputs.skip_checks != 'true' && (steps.auto_pin.outputs.pyhc_packages_changed == 'true' || github.event.inputs.force_build == 'true') && (github.event_name != 'workflow_dispatch' || github.event.inputs.generate_spreadsheet != 'false') && steps.compile.outcome == 'success'
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add spreadsheets/
        MSG="Add dependency spreadsheet"
        if [ "${{ steps.generate_spreadsheet.outputs.conflict_count }}" != "0" ]; then
          MSG="Add dependency conflict spreadsheet"
        fi
        git commit -m "$MSG" || echo "No spreadsheet changes"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ============================================
    # Trigger Binder Rebuild
    # ============================================
    - name: Update science-platforms-coordination to Trigger Binder Rebuild
      if: github.event.inputs.skip_checks == 'true' || ((steps.auto_pin.outputs.pyhc_packages_changed == 'true' || github.event.inputs.force_build == 'true') && steps.compile.outcome == 'success')
      run: |
        # Clone the target repo using a PAT with push permissions
        git clone https://${{ secrets.SCIENCE_PLATFORMS_PAT }}@github.com/heliophysicsPy/science-platforms-coordination.git coordination_repo
        cd coordination_repo
        git checkout pyhc

        # Use sed to update the 'FROM' line in the Dockerfile with the new version
        sed -i "s|^FROM spolson/pyhc-environment:.*|FROM spolson/pyhc-environment:${{ steps.build_and_push.outputs.docker_version }}|" binder/Dockerfile

        git config user.name 'github-actions[bot]'
        git config user.email 'github-actions[bot]@users.noreply.github.com'
        git add binder/Dockerfile

        if [ -z "$(git status --porcelain)" ]; then
          echo "No changes to commit."
        else
          git commit -m "Update base image version to ${{ steps.build_and_push.outputs.docker_version }}"
          git push origin pyhc
        fi

    # ============================================
    # Notifications
    # ============================================
    - name: Notify on Successful Push
      if: github.event.inputs.skip_checks == 'true' || ((steps.auto_pin.outputs.pyhc_packages_changed == 'true' || github.event.inputs.force_build == 'true') && steps.compile.outcome == 'success')
      uses: peter-evans/create-or-update-comment@v4
      with:
        issue-number: 2
        body: |
          **[Pipeline]** Docker Hub images and GitHub repo have been updated.

          ${{ github.event.inputs.skip_checks == 'true' && '**Mode:** Quick deploy (skipped checks)' || '' }}

          **PyHC packages updated:**
          ```
          ${{ steps.auto_pin.outputs.changed_packages || 'N/A (quick deploy mode)' }}
          ```

          ${{ steps.generate_spreadsheet.outputs.conflict_comment || '' }}

          ${{ steps.generate_spreadsheet.outputs.spec0_comment || '' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
